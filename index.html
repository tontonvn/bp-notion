<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>血圧管理（Notion同期・体重対応）</title>
  <style>
    :root { --bg:#f8fafc; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --accent:#0ea5e9; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;}
    .wrap{max-width:960px;margin:0 auto;padding:20px;}
    h1{font-size:1.4rem;margin:0 0 12px}
    .grid{display:grid;gap:16px;grid-template-columns: 1fr}
    @media(min-width:900px){ .grid{grid-template-columns: 1.1fr .9fr} }
    .card{background:var(--card);border-radius:16px;box-shadow:0 1px 4px rgba(15,23,42,.06);padding:14px 16px}
    .card h2{font-size:1.1rem;margin:0 0 8px}
    label{display:block;font-size:.9rem;margin:6px 0 4px;color:var(--muted)}
    input,select,button{font-size:1rem}
    input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #e2e8f0;background:#fff}
    .row{display:grid;gap:8px;grid-template-columns:1fr 1fr 1fr}
    .actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    button{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;background:var(--accent);color:#fff}
    button.secondary{background:#e2e8f0;color:#0f172a}
    button.danger{background:var(--bad)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;font-size:.95rem}
    th{text-align:left;color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.8rem}
    .pill.ok{background:#e8f7ee;color:var(--ok)}
    .pill.warn{background:#fff5e6;color:var(--warn)}
    .pill.bad{background:#ffefef;color:var(--bad)}
    canvas{width:100%;height:120px}
    .small{font-size:.85rem;color:var(--muted)}
    .inline{display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>血圧管理アプリ <span class="small">（Notion同期・体重対応／CSV入出力／簡易多変量回帰）</span></h1>

    <div class="grid">
      <div class="card">
        <h2>入力</h2>
        <div class="row">
          <div>
            <label>収縮期（上）mmHg</label>
            <input id="sbp" type="number" inputmode="numeric" placeholder="例: 128" />
          </div>
          <div>
            <label>拡張期（下）mmHg</label>
            <input id="dbp" type="number" inputmode="numeric" placeholder="例: 78" />
          </div>
          <div>
            <label>脈拍 bpm（任意）</label>
            <input id="hr" type="number" inputmode="numeric" placeholder="例: 68" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>体重 kg</label>
            <input id="wt" type="number" step="0.1" inputmode="decimal" placeholder="例: 62.4" />
          </div>
          <div>
            <label>測定日時</label>
            <input id="dt" type="datetime-local" />
          </div>
          <div>
            <label>測定部位</label>
            <select id="site"><option value="home">家庭</option><option value="office">診療室</option></select>
          </div>
        </div>
        <div class="row">
          <div style="grid-column:1 / span 3">
            <label>メモ（任意）</label>
            <input id="note" type="text" placeholder="起床後/就寝前など" />
          </div>
        </div>
        <div class="inline" style="margin-top:6px">
          <label class="inline"><input id="syncToggle" type="checkbox" /> Notionに自動同期する</label>
          <span class="small">同期先: <code id="syncEndpoint">(未設定)</code></span>
        </div>
        <div class="actions">
          <button id="saveBtn">保存</button>
          <button class="secondary" id="csvBtn">CSV書き出し</button>
          <button class="secondary" id="importBtn">CSV読み込み</button>
          <input id="fileIn" type="file" accept=".csv" style="display:none" />
          <button class="danger" id="delAllBtn">全データ削除</button>
        </div>
        <p class="small">※データはこの端末のブラウザ（localStorage）に保存。Notion同期はチェックON時にサーバーレス経由で送信します。</p>
      </div>

      <div class="card">
        <h2>目標値・判定</h2>
        <div class="inline small" style="margin-bottom:8px">
          <span>基準セット:</span>
          <select id="preset">
            <option value="home125">家庭: 125/75 未満</option>
            <option value="uniform130">一律: 130/80 未満</option>
            <option value="elderly135">家庭: 135/85 未満</option>
          </select>
        </div>
        <div class="row">
          <div>
            <label>目標（上）</label>
            <input id="targetSBP" type="number" value="125" />
          </div>
          <div>
            <label>目標（下）</label>
            <input id="targetDBP" type="number" value="75" />
          </div>
          <div>
            <label>対象</label>
            <select id="targetSite"><option value="home">家庭</option><option value="office">診療室</option></select>
          </div>
        </div>
        <div style="margin-top:10px"><div id="statusLine" class="small">—</div></div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <h2>直近7日サマリー</h2>
        <div id="weekStats">—</div>
        <canvas id="chart" aria-label="SBP/DBP 過去推移"></canvas>
      </div>
      <div class="card">
        <h2>簡易ML予測（多変量）</h2>
        <p class="small">過去30日から <code>SBP, DBP ~ 日数 + 体重</code> の重回帰で来週平均を予測（参考値）。</p>
        <div id="mlBox">—</div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>履歴</h2>
      <table id="tbl"><thead><tr><th>日時</th><th>場所</th><th>上</th><th>下</th><th>脈拍</th><th>体重</th><th>判定</th><th>メモ</th><th></th></tr></thead><tbody></tbody></table>
    </div>

    <p class="small" style="margin:20px 0">医療行為の代替ではありません。気になる値が続く場合は医療機関を受診してください。</p>
  </div>

<script>
const LS_KEY='bp_entries_v2';
const $=id=>document.getElementById(id);
const entries=load();
$('dt').value=new Date().toISOString().slice(0,16);

// ====== 環境に応じて変更（Netlify or Cloudflare のエンドポイント） ======
const ENDPOINT = (window.location.host.includes('netlify.app'))
  ? '/.netlify/functions/notion-sync'
  : (window.location.host.includes('workers.dev')||window.location.host.includes('pages.dev'))
    ? '/api/notion-sync'
    : ''; // GitHub Pages では空（同一オリジンにないためフルURLをlocalStorageで渡す）
$('syncEndpoint').textContent = localStorage.getItem('bp_sync_url') || ENDPOINT || '(未設定)';

$('preset').addEventListener('change', e=>{
  const v=e.target.value;
  if(v==='home125'){ $('targetSBP').value=125; $('targetDBP').value=75; $('targetSite').value='home'; }
  if(v==='uniform130'){ $('targetSBP').value=130; $('targetDBP').value=80; $('targetSite').value='office'; }
  if(v==='elderly135'){ $('targetSBP').value=135; $('targetDBP').value=85; $('targetSite').value='home'; }
  refresh();
});

$('saveBtn').onclick=async()=>{
  const sbp=num($('sbp').value), dbp=num($('dbp').value), hr=num($('hr').value), wt=num($('wt').value);
  const dt=$('dt').value? new Date($('dt').value): new Date();
  const note=$('note').value.trim(); const site=$('site').value;
  if(!sbp||!dbp){ alert('上と下を入力してください'); return; }
  const item={ sbp, dbp, hr:hr||null, wt:wt||null, t:dt.toISOString(), note, site };
  entries.push(item); save(); refresh();

  if($('syncToggle').checked){
    try{
      const url = localStorage.getItem('bp_sync_url') || ENDPOINT;
      if(!url){ throw new Error('同期URL未設定'); }
      const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(item)});
      if(!res.ok){ const msg=await res.text(); throw new Error('同期失敗: '+msg); }
    }catch(e){ console.error(e); alert('Notion同期エラー: '+e.message); }
  }
  clearInputs();
};

$('csvBtn').onclick=()=>{ const csv=toCSV(entries); download(csv,'bp.csv'); };
$('importBtn').onclick=()=>{ $('fileIn').click(); };
$('fileIn').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ overwrite(fromCSV(r.result)); }; r.readAsText(f); };
$('delAllBtn').onclick=()=>{ if(confirm('本当に全削除しますか？')){ localStorage.removeItem(LS_KEY); entries.splice(0); refresh(); } };

function clearInputs(){ $('sbp').value=''; $('dbp').value=''; $('hr').value=''; $('wt').value=''; $('note').value=''; $('dt').value=new Date().toISOString().slice(0,16); }
function num(v){ const n=Number(v); return Number.isFinite(n)?n:null; }
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(entries)); }
function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }
function overwrite(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); entries.splice(0, entries.length, ...arr); refresh(); }

function judge(sbp,dbp,t){ if(sbp<t.sbp && dbp<t.dbp) return ['達成','ok']; if(sbp<t.sbp+5 && dbp<t.dbp+5) return ['やや高め','warn']; return ['高め','bad']; }
function target(){ return { sbp:num($('targetSBP').value)||130, dbp:num($('targetDBP').value)||80, site:$('targetSite').value } }

function refresh(){
  const tbody=$('tbl').querySelector('tbody'); tbody.innerHTML=''; const t=target();
  [...entries].sort((a,b)=>new Date(b.t)-new Date(a.t)).forEach((e,i)=>{
    const j=judge(e.sbp,e.dbp,t);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(e.t)}</td><td>${e.site==='home'?'家庭':'診療室'}</td><td>${e.sbp}</td><td>${e.dbp}</td><td>${e.hr??''}</td><td>${e.wt??''}</td><td><span class="pill ${j[1]}">${j[0]}</span></td><td>${escapeHTML(e.note||'')}</td><td><button class="secondary" data-i="${i}">削除</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button').forEach(btn=>{
    btn.onclick=()=>{ const idx=Number(btn.dataset.i); const original=[...entries].sort((a,b)=>new Date(b.t)-new Date(a.t)); const item=original[idx]; const pos=entries.findIndex(x=>x.t===item.t && x.sbp===item.sbp && x.dbp===item.dbp); if(pos>-1){ entries.splice(pos,1); save(); refresh(); } };
  });

  const week=entries.filter(e=>new Date(e.t)>=addDays(new Date(),-7)); const s=stats(week);
  $('weekStats').innerHTML=s.count? `件数:${s.count}／平均 上${s.avgSBP.toFixed(0)} 下${s.avgDBP.toFixed(0)} ／最小 上${s.minSBP} 下${s.minDBP} ／最大 上${s.maxSBP} 下${s.maxDBP}`:'直近7日にデータがありません';

  const three=entries.filter(e=>new Date(e.t)>=addDays(new Date(),-3)); const s3=stats(three);
  if(s3.count){ const j=judge(s3.avgSBP,s3.avgDBP,t); $('statusLine').innerHTML=`直近3日平均: 上${s3.avgSBP.toFixed(0)} 下${s3.avgDBP.toFixed(0)} → <span class="pill ${j[1]}">${j[0]}</span>`; } else { $('statusLine').textContent='直近3日平均: データ不足'; }

  drawChart(entries); runML();
}

function stats(arr){ if(!arr.length) return {count:0}; const sbps=arr.map(e=>e.sbp), dbps=arr.map(e=>e.dbp); const avg=a=>a.reduce((x,y)=>x+y,0)/a.length; return { count:arr.length, avgSBP:avg(sbps), avgDBP:avg(dbps), minSBP:Math.min(...sbps), maxSBP:Math.max(...sbps), minDBP:Math.min(...dbps), maxDBP:Math.max(...dbps)}; }
function drawChart(arr){ const c=$('chart'), ctx=c.getContext('2d'); const w=c.width=c.clientWidth*devicePixelRatio, h=c.height=c.clientHeight*devicePixelRatio; ctx.clearRect(0,0,w,h); if(!arr.length){ ctx.fillStyle='#94a3b8'; ctx.fillText('データなし',10,20); return; } const sorted=[...arr].sort((a,b)=>new Date(a.t)-new Date(b.t)); const xs=sorted.map(e=>new Date(e.t).getTime()); const minX=Math.min(...xs), maxX=Math.max(...xs); const pad=20; const sbps=sorted.map(e=>e.sbp), dbps=sorted.map(e=>e.dbp); const minY=Math.min(Math.min(...dbps),50), maxY=Math.max(Math.max(...sbps),180); const scaleX=x=> pad+(x-minX)/(maxX-minX||1)*(w-2*pad); const scaleY=y=> h-(y-minY)/(maxY-minY||1)*(h-2*pad); const line=vals=>{ ctx.beginPath(); vals.forEach((v,i)=>{ const x=scaleX(xs[i]), y=scaleY(v); i?ctx.lineTo(x,y):ctx.moveTo(x,y); }); ctx.lineWidth=2; ctx.stroke(); }; ctx.strokeStyle='#0f172a'; line(sbps); ctx.strokeStyle='#64748b'; line(dbps); }

// ====== 多変量回帰（SBP/DBP ~ 日数 + 体重） ======
function runML(){
  const now=new Date(); const from=addDays(now,-30);
  const last30=entries.filter(e=>new Date(e.t)>=from && e.wt!=null).sort((a,b)=>new Date(a.t)-new Date(b.t));
  const box=$('mlBox');
  if(last30.length<5){ box.textContent='データが5件以上たまると予測します（体重含む）'; return; }
  const x1=last30.map((_,i)=>i); // 日数（0,1,2,...）
  const x2=last30.map(e=>Number(e.wt));
  const yS=last30.map(e=>Number(e.sbp));
  const yD=last30.map(e=>Number(e.dbp));

  const modelS=mlr2(x1,x2,yS); // {a,b,c}: y=a*x1+b*x2+c
  const modelD=mlr2(x1,x2,yD);
  const start=x1[x1.length-1]+1, H=7;
  const predAvg=(m)=>{ let s=0; for(let i=0;i<H;i++){ s += m.a*(start+i)+m.b*avg(x2)+m.c; } return s/H; };
  const pSBP=predAvg(modelS), pDBP=predAvg(modelD);
  const t=target(); const j=judge(pSBP,pDBP,t);
  box.innerHTML=`次週平均予測: 上${pSBP.toFixed(0)} 下${pDBP.toFixed(0)} → <span class="pill ${j[1]}">${j[0]}</span><br><span class="small">（説明変数: 日数・体重／正規方程式）</span>`;
}

// 2変数の最小二乗：正規方程式で解く
function mlr2(x1,x2,y){
  const n=x1.length; const sx1=sum(x1), sx2=sum(x2), sy=sum(y);
  const sx1x1=sum(x1.map(v=>v*v));
  const sx2x2=sum(x2.map(v=>v*v));
  const sx1x2=sum(x1.map((v,i)=>v*x2[i]));
  const sx1y=sum(x1.map((v,i)=>v*y[i]));
  const sx2y=sum(x2.map((v,i)=>v*y[i]));
  const M=[
    [sx1x1, sx1x2, sx1],
    [sx1x2, sx2x2, sx2],
    [sx1,   sx2,    n ]
  ];
  const v=[sx1y, sx2y, sy];
  const coeff=solve3(M,v); // [a,b,c]
  return {a:coeff[0], b:coeff[1], c:coeff[2]};
}
function solve3(M,v){ // ガウス消去
  const A=M.map((r,i)=>[...r,v[i]]);
  for(let i=0;i<3;i++){
    let p=i; for(let r=i+1;r<3;r++){ if(Math.abs(A[r][i])>Math.abs(A[p][i])) p=r; }
    if(p!==i){ const tmp=A[i]; A[i]=A[p]; A[p]=tmp; }
    const pivot=A[i][i]||1e-12;
    for(let j=i;j<4;j++) A[i][j]/=pivot;
    for(let r=0;r<3;r++) if(r!==i){ const f=A[r][i]; for(let j=i;j<4;j++) A[r][j]-=f*A[i][j]; }
  }
  return [A[0][3],A[1][3],A[2][3]];
}
const sum=a=>a.reduce((x,y)=>x+y,0); const avg=a=>sum(a)/a.length;

function addDays(d,n){ const dd=new Date(d); dd.setDate(dd.getDate()+n); return dd; }
function fmt(iso){ const d=new Date(iso); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`; }
function escapeHTML(s){ 
  return s.replace(/[&<>"]/g,
    m => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;"
    }[m])
  ); 
}

function toCSV(arr){ const header='datetime,site,sbp,dbp,hr,wt,note\n'; const rows=arr.map(e=>[e.t,e.site,e.sbp,e.dbp,e.hr??'',e.wt??'',(e.note||'').replace(/\n/g,' ')].join(',')); return header+rows.join('\n'); }
function fromCSV(text){ const lines=text.trim().split(/\r?\n/), out=[], idx={}; lines[0].split(',').forEach((h,i)=>idx[h.trim()]=i); for(let i=1;i<lines.length;i++){ const c=lines[i].split(','); out.push({ t:c[idx.datetime], site:c[idx.site]||'home', sbp:Number(c[idx.sbp]), dbp:Number(c[idx.dbp]), hr:c[idx.hr]?Number(c[idx.hr]):null, wt:c[idx.wt]?Number(c[idx.wt]):null, note:c[idx.note]||'' }); } return out; }

refresh();
// 任意：同期URLをブラウザに保存（GitHub Pages → サブドメインが異なる場合に必要）
window.setSyncUrl=function(url){ localStorage.setItem('bp_sync_url', url); $('syncEndpoint').textContent=url; };
</script>
</body>
</html>
